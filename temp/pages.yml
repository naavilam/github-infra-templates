---
name: Build & Deploy Jekyll

on:
  push:
    branches: ["main"]
    paths-ignore:
      - ".github/**"
      - "README.md"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install Jekyll and dependencies
        run: |
          gem install bundler jekyll
          bundle install --path vendor/bundle || true

      - name: Build Jekyll site
        run: bundle exec jekyll build

      - name: Install image optimization tools
        run: |
          sudo apt-get update
          sudo apt-get install -y webp jpegoptim pngquant

      - name: Optimize JPG and PNG in _site
        run: |
          set -euo pipefail

          # JPEG (jpg)
          find _site -type f -iname '*.jpg'  -print0 \
            | xargs -0 -r -I{} jpegoptim --strip-all --max=75 "{}" || true

          # JPEG (jpeg)
          find _site -type f -iname '*.jpeg' -print0 \
            | xargs -0 -r -I{} jpegoptim --strip-all --max=75 "{}" || true

          # PNG
          find _site -type f -iname '*.png'  -print0 \
            | xargs -0 -r -I{} pngquant --quality=65-80 --force --ext .png "{}" || true

      - name: Generate WebP versions
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r -d '' f; do
            cwebp -q 70 -mt "$f" -o "${f%.*}.webp"
          done < <(find _site -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) -print0)

      - name: Verificar imagens WebP geradas
        shell: bash
        run: |
          echo "=== Arquivos WebP encontrados ==="
          find _site -type f -name "*.webp" | head -n 30 || echo "Nenhum arquivo .webp encontrado."
          echo "=== Contagem total ==="
          find _site -type f -name "*.webp" | wc -l

      - name: Rebuild HTML to use <picture> with WebP + lazy loading
        shell: bash
        run: |
          python3 - <<'PY'
          import re, pathlib

          root = pathlib.Path("_site")
          img_re = re.compile(r'<img\s+([^>]*?)src="([^"]+\.(?:jpe?g|png))"([^>]*)>', re.I)

          def repl(m):
              pre = m.group(1).strip()
              src = m.group(2)
              post = m.group(3).strip()
              webp = re.sub(r'\.(jpe?g|png)$', '.webp', src, flags=re.I)
              before = (pre + " ").strip()
              after = (" " + post).strip() if post else ""
              combo = (pre + post).lower()
              if "loading=" not in combo:
                  after += ' loading="lazy"'
              if "decoding=" not in combo:
                  after += ' decoding="async"'
              return f'<picture><source srcset="{webp}" type="image/webp"><img {before}src="{src}"{after}></picture>'

              for p in root.rglob("*.html"):
                  txt = p.read_text(encoding="utf-8", errors="ignore")
                  new = img_re.sub(repl, txt)
                  if new != txt:
                      p.write_text(new, encoding="utf-8")
              PY

      - name: Upload artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
