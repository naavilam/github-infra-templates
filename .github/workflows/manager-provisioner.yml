name: Provision Manager Website + Secrets

on:
  workflow_dispatch:
    inputs:
      org:
        description: "Target organization"
        required: true
      templates_repo:
        description: "Templates repo (owner/name)"
        required: false
        default: "naavila/github-infra-templates"
      templates_ref:
        description: "Branch/tag/sha in templates repo"
        required: false
        default: "main"

permissions:
  contents: read

jobs:
  provision:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout templates repo (public -> GITHUB_TOKEN ok)
      - name: Checkout templates
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          path: templates

      # 2) Create an installation token for Provisioner App scoped to the target org
      - name: Create Provisioner installation token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PROVISIONER_APP_ID }}
          private-key: ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM }}
          owner: ${{ inputs.org }}

      # 3) Install gh CLI (usually already present, but keep explicit)
      - name: Ensure gh is available
        run: gh --version

      # 4) Create repo {org}.github.io if missing
      - name: Create {org}.github.io repo (if missing)
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"

          if gh api "repos/${ORG}/${REPO}" >/dev/null 2>&1; then
            echo "Repo already exists: ${ORG}/${REPO}"
          else
            echo "Creating repo: ${ORG}/${REPO}"
            gh api "orgs/${ORG}/repos" -X POST -f name="$REPO" -f private=false -f description="Org website for ${ORG}" >/dev/null
          fi

      # 5) Build the site payload from templates (website + registry + assets + workflows)
      - name: Assemble website payload
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail

          ROOT="$PWD"
          OUT="$ROOT/out"
          rm -rf "$OUT"
          mkdir -p "$OUT/.github/workflows"
          mkdir -p "$OUT/.github/registry"
          mkdir -p "$OUT/_posts" 

          # --- Website base ---
          # copies everything from manager_website/ into repo root
          rsync -a --delete \
            "$ROOT/templates/manager/manager_website/" \
            "$OUT/"

          # --- Registry for this org ---
          REG="$ROOT/templates/manager/manager_registry/${ORG}-registry.yml"
          if [[ ! -f "$REG" ]]; then
            echo "❌ Missing registry file: $REG" >&2
            echo "Available registry files:" >&2
            ls -la "$ROOT/templates/manager/manager_registry" >&2 || true
            exit 1
          fi
          cp "$REG" "$OUT/.github/registry/registry.yml"

          # --- Assets for this org ---
          ASSETS_DIR="$ROOT/templates/manager/manager_assets/${ORG}"
          if [[ ! -d "$ASSETS_DIR" ]]; then
            echo "❌ Missing assets dir: $ASSETS_DIR" >&2
            echo "Available assets dirs:" >&2
            ls -la "$ROOT/templates/manager/manager_assets" >&2 || true
            exit 1
          fi

          # Copy assets "as-is" into repo root (preserves internal structure)
          rsync -a \
            "$ASSETS_DIR/" \
            "$OUT/"

          # --- Workflows ---
          rsync -a --delete \
            "$ROOT/templates/manager/manager_workflows/" \
            "$OUT/.github/workflows/"

          echo "✅ Payload assembled at: $OUT"
          find "$OUT" -maxdepth 3 -type f | sed 's#^'"$OUT"'#OUT#'

      - name: Generate _posts from registry (assembly_posts.py)
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          python -V

          REG="$GITHUB_WORKSPACE/out/.github/registry/registry.yml"
          OUTPOSTS="$GITHUB_WORKSPACE/out/_posts"

          # ajuste o caminho do script conforme você decidir onde ele fica no templates repo
          SCRIPT="$GITHUB_WORKSPACE/templates/manager/manager_scripts/assembly_posts.py"

          if [[ ! -f "$SCRIPT" ]]; then
            echo " Missing script: $SCRIPT" >&2
            exit 1
          fi

          python "$SCRIPT" \
            --org "$ORG" \
            --registry "$REG" \
            --out-posts "$OUTPOSTS"

          echo "_posts generated:"
          ls -la "$OUTPOSTS" || true


      # 6) Push payload into {org}.github.io using app token
      - name: Push content to {org}.github.io
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"

          git config --global user.name  "provisioner[bot]"
          git config --global user.email "provisioner[bot]@users.noreply.github.com"

          rm -rf target
          mkdir -p target
          cd target

          git init
          git branch -M main

          # Add all assembled files
          rsync -a "$GITHUB_WORKSPACE/out/" .

          git add -A
          git commit -m "Provision manager website for ${ORG}" || echo "Nothing to commit."

          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${ORG}/${REPO}.git"
          git push -u origin main --force

      # 7) Set 6 org secrets on {org}
      - name: Set org secrets (dispatcher + provisioner)
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ORG: ${{ inputs.org }}
          DISPATCHER_APP_ID: ${{ secrets.DISPATCHER_APP_ID }}
          DISPATCHER_PRIVATE_KEY_PEM: ${{ secrets.DISPATCHER_PRIVATE_KEY_PEM }}
          PROVISIONER_APP_ID: ${{ secrets.PROVISIONER_APP_ID }}
          PROVISIONER_PRIVATE_KEY_PEM: ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail

          # You asked for 6 org secrets: IDs + PEMs for dispatcher and provisioner
          echo "$DISPATCHER_APP_ID"            | gh secret set DISPATCHER_APP_ID            --org "$ORG" --visibility private
          echo "$DISPATCHER_PRIVATE_KEY_PEM"   | gh secret set DISPATCHER_PRIVATE_KEY_PEM   --org "$ORG" --visibility private
          echo "$PROVISIONER_APP_ID"           | gh secret set PROVISIONER_APP_ID           --org "$ORG" --visibility private
          echo "$PROVISIONER_PRIVATE_KEY_PEM"  | gh secret set PROVISIONER_PRIVATE_KEY_PEM  --org "$ORG" --visibility private

          # Você listou 4 nomes aqui; como você disse "6", eu deixei os 4 explícitos.
          # Se os outros 2 forem, por exemplo, INSTALLATION_IDs ou WEBHOOK_SECRET,
          # adicione aqui exatamente com os nomes desejados.

          echo "✅ Org secrets set on $ORG"

      # 8) Set 2 repo secrets on {org}.github.io (auditor)
      - name: Set repo secrets on {org}.github.io (auditor)
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ORG: ${{ inputs.org }}
          AUDITOR_APP_ID: ${{ secrets.AUDITOR_APP_ID }}
          AUDITOR_PRIVATE_KEY_PEM: ${{ secrets.AUDITOR_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"
          TARGET="${ORG}/${REPO}"

          echo "$AUDITOR_APP_ID"            | gh secret set AUDITOR_APP_ID            --repo "$TARGET"
          echo "$AUDITOR_PRIVATE_KEY_PEM"   | gh secret set AUDITOR_PRIVATE_KEY_PEM   --repo "$TARGET"

          echo "✅ Repo secrets set on $TARGET"

      # 9) (Optional) Enable Pages (for org site it usually just needs repo + settings)
      - name: Enable GitHub Pages (optional)
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"

          # Try to enable Pages from main branch root. If already enabled, ignore.
          gh api "repos/${ORG}/${REPO}/pages" -X POST \
            -f source[branch]=main \
            -f source[path]="/" \
            >/dev/null 2>&1 || true

          echo "✅ Pages enable attempted for ${ORG}/${REPO}"


      # se o primeiro falhar
      # - name: Enable GitHub Pages on main (root)
      #   env:
      #     GH_TOKEN: ${{ steps.app_token.outputs.token }}
      #     ORG: ${{ inputs.org }}
      #   run: |
      #     set -euo pipefail
      #     REPO="${ORG}.github.io"

      #     # Cria Pages se não existir; se existir, atualiza.
      #     # POST pode falhar se já existir, então tentamos POST e depois PUT.
      #     gh api "repos/${ORG}/${REPO}/pages" -X POST \
      #       -f source[branch]=main \
      #       -f source[path]="/" \
      #       >/dev/null 2>&1 || true

      #     # Atualiza a fonte para main:/ (idempotente)
      #     gh api "repos/${ORG}/${REPO}/pages" -X PUT \
      #       -f source[branch]=main \
      #       -f source[path]="/" \
      #       >/dev/null 2>&1 || true

      #     echo "✅ Pages set to main:/ for ${ORG}/${REPO}"