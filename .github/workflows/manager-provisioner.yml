name: Provision Manager Website + Secrets

on:
  workflow_dispatch:
    inputs:
      org:
        description: "Target organization"
        required: true
      templates_repo:
        description: "Templates repo (owner/name)"
        required: false
        default: "naavilam/github-infra-templates"
      templates_ref:
        description: "Branch/tag/sha in templates repo"
        required: false
        default: "main"

permissions:
  contents: read
  id-token: write

jobs:
  provision:
    runs-on: ubuntu-latest
    environment: ${{ inputs.org }}

    steps:
      - name: Ensure gh is available
        run: gh --version

      # 0) Mint token (no mesmo job) + exporta para GH_TOKEN
      - name: Create Provisioner installation token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          # ROOT creds (repo-level)
          app-id: ${{ vars.ROOT_PROVISIONER_APP_ID }}
          private-key: ${{ secrets.ROOT_PROVISIONER_PRIVATE_KEY_PEM }}
          owner: ${{ inputs.org }}

      - name: Export GH_TOKEN for rest of job (no leak)
        shell: bash
        run: |
          set -euo pipefail
          tok='${{ steps.app_token.outputs.token }}'
          echo "mint: token length = ${#tok}"
          [[ "${#tok}" -ge 20 ]]
          echo "GH_TOKEN=$tok" >> "$GITHUB_ENV"

      - name: Sanity check auth
        shell: bash
        run: |
          set -euo pipefail
          gh auth status

      # 1) Checkout templates repo (public -> GITHUB_TOKEN ok)
      - name: Checkout templates
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          path: templates

      # 2) Create repo {org}.github.io if missing
      - name: Create {org}.github.io repo (if missing)
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"

          if gh api "repos/${ORG}/${REPO}" >/dev/null 2>&1; then
            echo "Repo already exists: ${ORG}/${REPO}"
          else
            echo "Creating repo: ${ORG}/${REPO}"
            gh api "orgs/${ORG}/repos" -X POST -f name="$REPO" -f private=false -f description="Org website for ${ORG}" >/dev/null
          fi

      # 3) Build payload
      - name: Assemble website payload
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail

          ROOT="$PWD"
          OUT="$ROOT/out"
          rm -rf "$OUT"
          mkdir -p "$OUT/.github/workflows" "$OUT/.github/registry" "$OUT/_posts"

          rsync -a --delete \
            "$ROOT/templates/manager/manager_website/" \
            "$OUT/"

          REG="$ROOT/templates/manager/manager_registry/${ORG}-registry.yml"
          if [[ ! -f "$REG" ]]; then
            echo "❌ Missing registry file: $REG" >&2
            ls -la "$ROOT/templates/manager/manager_registry" >&2 || true
            exit 1
          fi

          mkdir -p "$OUT/.github/registry"
          cp "$REG" "$OUT/.github/registry/registry.yml"

          ASSETS_DIR="$ROOT/templates/manager/manager_assets/${ORG}"
          if [[ ! -d "$ASSETS_DIR" ]]; then
            echo "❌ Missing assets dir: $ASSETS_DIR" >&2
            ls -la "$ROOT/templates/manager/manager_assets" >&2 || true
            exit 1
          fi
          rsync -a "$ASSETS_DIR/" "$OUT/"

          rsync -a --delete \
            "$ROOT/templates/manager/manager_workflows/" \
            "$OUT/.github/workflows/"

          echo "✅ Payload assembled at: $OUT"

      - name: Install python deps for assembly
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Generate _posts from registry (assembly_posts.py)
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REG="$GITHUB_WORKSPACE/out/.github/registry/registry.yml"
          OUTPOSTS="$GITHUB_WORKSPACE/out/_posts"
          SCRIPT="$GITHUB_WORKSPACE/templates/manager/manager_scripts/assembly_posts.py"

          [[ -f "$SCRIPT" ]] || (echo "Missing script: $SCRIPT" >&2; exit 1)

          python "$SCRIPT" \
            --org "$ORG" \
            --registry "$REG" \
            --out-posts "$OUTPOSTS"

      - name: Inject GA tracking id into out/_config.yml
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, yaml

          org = os.environ["ORG"]
          ws = os.environ["GITHUB_WORKSPACE"]

          orgs_yml = os.path.join(ws, "templates", "orgs.yml")
          config_yml = os.path.join(ws, "out", "_config.yml")

          with open(orgs_yml, "r", encoding="utf-8") as f:
              data = yaml.safe_load(f) or {}

          entry = next((x for x in (data.get("orgs") or []) if x.get("name") == org), None)
          if not entry:
              raise SystemExit(f"ORG not found in orgs.yml: {org}")

          ga_id = entry.get("ga_analytics")

          with open(config_yml, "r", encoding="utf-8") as f:
              cfg = yaml.safe_load(f) or {}

          if ga_id:
              cfg["ga_tracking_id"] = ga_id
              print(f"Injected ga_tracking_id = {ga_id}")
          else:
              cfg.pop("ga_tracking_id", None)
              print("No GA tracking id found; ga_tracking_id not set")

          with open(config_yml, "w", encoding="utf-8") as f:
              yaml.safe_dump(cfg, f, sort_keys=False, allow_unicode=True)
          PY

      # 4) Push payload into {org}.github.io
      - name: Push content to {org}.github.io
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"

          git config --global user.name  "provisioner[bot]"
          git config --global user.email "provisioner[bot]@users.noreply.github.com"

          rm -rf target
          mkdir -p target
          cd target

          git init
          git branch -M main

          rsync -a "$GITHUB_WORKSPACE/out/" .

          git add -A
          git commit -m "Provision manager website for ${ORG}" || echo "Nothing to commit."

          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${ORG}/${REPO}.git"
          git push -u origin main --force

      # 5) Set org secrets
      - name: Set org secrets (dispatcher + provisioner)
        env:
          ORG: ${{ inputs.org }}
          DISPATCHER_APP_ID: ${{ vars.DISPATCHER_APP_ID }}
          DISPATCHER_PRIVATE_KEY_PEM: ${{ secrets.DISPATCHER_PRIVATE_KEY_PEM }}
          PROVISIONER_APP_ID: ${{ vars.PROVISIONER_APP_ID }}
          PROVISIONER_PRIVATE_KEY_PEM: ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          echo "$DISPATCHER_APP_ID"            | gh secret set DISPATCHER_APP_ID            --org "$ORG" --visibility private
          echo "$DISPATCHER_PRIVATE_KEY_PEM"   | gh secret set DISPATCHER_PRIVATE_KEY_PEM   --org "$ORG" --visibility private
          echo "$PROVISIONER_APP_ID"           | gh secret set PROVISIONER_APP_ID           --org "$ORG" --visibility private
          echo "$PROVISIONER_PRIVATE_KEY_PEM"  | gh secret set PROVISIONER_PRIVATE_KEY_PEM  --org "$ORG" --visibility private

      # 6) Set repo secrets (auditor only)
      - name: Set auditor secrets on {org}.github.io
        env:
          ORG: ${{ inputs.org }}
          AUDITOR_APP_ID: ${{ vars.AUDITOR_APP_ID }}
          AUDITOR_PRIVATE_KEY_PEM: ${{ secrets.AUDITOR_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          TARGET="${ORG}/${ORG}.github.io"
          echo "$AUDITOR_APP_ID"           | gh secret set AUDITOR_APP_ID           --repo "$TARGET"
          echo "$AUDITOR_PRIVATE_KEY_PEM"  | gh secret set AUDITOR_PRIVATE_KEY_PEM  --repo "$TARGET"

      # 7) Enable Pages (optional)
      - name: Enable GitHub Pages (optional)
        env:
          ORG: ${{ inputs.org }}
        run: |
          set -euo pipefail
          REPO="${ORG}.github.io"
          gh api "repos/${ORG}/${REPO}/pages" -X POST \
            -f source[branch]=main \
            -f source[path]="/" >/dev/null 2>&1 || true