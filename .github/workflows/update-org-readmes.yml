name: Update org READMEs

on:
  workflow_call:
    inputs:
      repo:
        description: "Target repository or else all."
        required: false
        type: string
        default: ""
      registry_path:
        type: string
        required: false
        default: ".github/registry/repos.yml"
    secrets:
      PROVISIONER_APP_ID:
        required: true
      PROVISIONER_PRIVATE_KEY_PEM:
        required: true

permissions:
  contents: write

env:
  CENTRAL_REPO: naavilam/github-infra-templates
  TEMPLATE_REF: main
  MAX_PARALLEL: "10"

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}

    steps:
      - name: Checkout manager repo (registry)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - id: set
        name: Build matrix from registry (with embedded cfg)
        shell: bash
        env:
          REPO_FILTER: ${{ inputs.repo }}
          REGISTRY_PATH: ${{ inputs.registry_path }}
        run: |
          set -euo pipefail

          MATRIX="$(python - <<'PY'
          import os, sys, json, yaml, base64
          from pathlib import Path

          repo_filter = (os.environ.get("REPO_FILTER") or "").strip().lower()
          reg_path = Path(os.environ.get("REGISTRY_PATH") or ".github/registry/repos.yml")

          owner = (os.environ.get("GITHUB_REPOSITORY_OWNER") or "").strip()

          if not reg_path.exists():
            print(json.dumps({"include": []}))
            sys.exit(0)

          data = yaml.safe_load(reg_path.read_text(encoding="utf-8")) or {}
          items = data.get("repos", [])
          if not isinstance(items, list):
            items = []

          include = []

          for it in items:
            name = str(it.get("name","")).strip()
            org  = str(it.get("org","")).strip() or owner
            if not name or not org:
              continue
            if repo_filter and name.lower() != repo_filter:
              continue

            # --- placeholders mínimos pro README ---
            course_id = (it.get("id") or "").strip() or (name.split("-",1)[0] if "-" in name else name)
            title = (it.get("title") or "").strip()
            if not title:
              rest = name.split("-", 1)[1] if "-" in name else name
              title = rest.replace("-", " ").strip()

            site_url = (it.get("site_url") or "").strip()
            if not site_url:
              site_url = f"https://{org}.github.io/" if name == f"{org}.github.io" else f"https://{org}.github.io/{name}"

            area  = (it.get("academic_area") or "").strip()
            level = (it.get("academic_level") or "").strip()
            if level:
              lvl = level.lower().strip()
              if lvl == "undergrad": level = "Undergraduate Course"
              elif lvl == "grad": level = "Graduate Course"
              else: level = level[:1].upper() + level[1:]

            tagline = (it.get("readme_tagline") or "").strip()
            if not tagline:
              parts = [p for p in [area, level] if p]
              tagline = " • ".join(parts) if parts else "lectures • notebooks • references"

            cfg = {
              "TITLE_1": course_id,
              "TITLE_2": title,
              "REPO_TAGLINE": tagline,
              "CTA_TEXT": (it.get("readme_cta_text") or "Access the full course website").strip(),
              "THEME": (it.get("readme_theme") or "coding").strip(),
              "SITE_URL": site_url,
              "ASSETS_DIR": (it.get("readme_assets_dir") or ".github/readme").strip(),
            }

            payload = json.dumps(cfg, separators=(",", ":"), ensure_ascii=False).encode("utf-8")
            cfg_b64 = base64.urlsafe_b64encode(payload).decode("ascii")

            include.append({
              "repo": f"{org}/{name}",
              "cfg_b64": cfg_b64
            })

          print(json.dumps({"include": include}))
          PY
          )"

          echo "matrix=${MATRIX}" >> "$GITHUB_OUTPUT"

  apply:
    needs: plan
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}

    steps:
      - name: Guardrail context (safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== context ==="
          echo "event=${{ github.event_name }}"
          echo "repo=${{ github.repository }}"
          echo "owner=${{ github.repository_owner }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"
          echo "actor=${{ github.actor }}"
          echo "workflow=${{ github.workflow }}"
          echo "job=${{ github.job }}"
          echo "run_id=${{ github.run_id }}"
          echo "run_number=${{ github.run_number }}"
          echo "runner_name=${{ runner.name }}"
          echo "runner_os=${{ runner.os }}"
          echo "runner_arch=${{ runner.arch }}"
          echo "workspace=${{ github.workspace }}"
          echo ""

      - name: Guardrail secrets presence (safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== secrets presence ==="
          echo "has PROVISIONER_APP_ID? ${{ secrets.PROVISIONER_APP_ID != '' }}"
          echo "has PROVISIONER_PRIVATE_KEY_PEM? ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM != '' }}"
          echo "has DISPATCHER_APP_ID? ${{ secrets.DISPATCHER_APP_ID != '' }}"
          echo "has DISPATCHER_PRIVATE_KEY_PEM? ${{ secrets.DISPATCHER_PRIVATE_KEY_PEM != '' }}"
          echo ""

      - name: Guardrail sanity of PROVISIONER_APP_ID (safe)
        shell: bash
        env:
          APP_ID: ${{ secrets.PROVISIONER_APP_ID }}
        run: |
          set -euo pipefail
          echo "=== app-id sanity ==="
          if [[ -z "${APP_ID:-}" ]]; then
            echo "::error::PROVISIONER_APP_ID is empty in this job context."
            exit 2
          fi
          # não printa o valor; só valida formato (número)
          if [[ ! "${APP_ID}" =~ ^[0-9]+$ ]]; then
            echo "::error::PROVISIONER_APP_ID is present but not purely numeric (check spaces/quotes)."
            exit 3
          fi
          echo "app-id looks numeric: ok"
          
      - name: Mint Provisioner GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PROVISIONER_APP_ID }}
          private-key: ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM }}
          owner: ${{ github.repository_owner }}

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ steps.app-token.outputs.token }}
          path: target
          fetch-depth: 0

      - name: Checkout central templates + scripts
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CENTRAL_REPO }}
          ref: ${{ env.TEMPLATE_REF }}
          path: central
          sparse-checkout: |
            bootstrap/repo_readme
            bootstrap/repo_scripts/build_readme.py
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Write _cfg/readme.yml from matrix payload
        shell: bash
        env:
          CFG_B64: ${{ matrix.cfg_b64 }}
        run: |
          set -euo pipefail
          mkdir -p _cfg
          python - <<'PY'
          import os, json, base64, yaml
          b64 = os.environ["CFG_B64"]
          data = base64.urlsafe_b64decode(b64.encode("ascii")).decode("utf-8")
          cfg = json.loads(data)
          with open("_cfg/readme.yml", "w", encoding="utf-8") as f:
            yaml.safe_dump(cfg, f, sort_keys=False, allow_unicode=True)
          print("[ok] wrote _cfg/readme.yml")
          PY

      - name: Build + commit + push
        shell: bash
        run: |
          set -euo pipefail

          python central/bootstrap/repo_scripts/build_readme.py \
            --repo target \
            --central central/bootstrap/repo_readme \
            --repo-cfg _cfg

          cd target

          ORG_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          BOT="${ORG_LC}-provisioner-app[bot]"

          git config user.name "${BOT}"
          git config user.email "${BOT}@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git add README.md .github/readme || true
          git commit -m "chore: update README"
          git push